<!doctype html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Mu.To – Navigator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 40px;
    }

    h1 { margin-bottom: 20px; }

    .box {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 500px;
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }

    select, button {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      box-sizing: border-box;
    }

    button { margin-top: 20px; cursor: pointer; }

    .hidden { display: none !important; }
  </style>
</head>

<body>

<!-- ================= HOME SELEZIONE ================= -->
<div id="home">
  <h1>Seleziona museo e percorso</h1>

  <div class="box">
    <label>Museo</label>
    <select id="museo">
      <option value="">— seleziona museo —</option>
    </select>

    <label>Percorso</label>
    <select id="percorso" disabled>
      <option value="">— seleziona percorso —</option>
    </select>

    <button id="apri">Apri</button>
  </div>
</div>

<!-- ================= ROOT REACT ================= -->
<div id="root" class="hidden"></div>

<script>
/* ================= SESSION ================= */

const COOKIE = "museo_session";
const MAX_AGE = 24 * 60 * 60 * 1000;
const API = "/api";

const home = document.getElementById("home");
const root = document.getElementById("root");

const museoSel = document.getElementById("museo");
const percorsoSel = document.getElementById("percorso");
const btn = document.getElementById("apri");

function getSession() {
  const m = document.cookie.match(new RegExp("(^| )" + COOKIE + "=([^;]+)"));
  if (!m) return null;
  try { return JSON.parse(decodeURIComponent(m[2])); }
  catch { return null; }
}

function setSession(s) {
  document.cookie =
    COOKIE + "=" + encodeURIComponent(JSON.stringify(s)) +
    "; max-age=" + (MAX_AGE / 1000) + "; path=/; SameSite=Lax";
}

function validSession(s) {
  return s &&
    typeof s.museo === "string" &&
    Array.isArray(s.percorso) &&
    s.percorso.length >= 2 &&
    Date.now() - s.createdAt <= MAX_AGE;
}

function startReact() {
  home.classList.add("hidden");
  root.classList.remove("hidden");
  window.dispatchEvent(new Event("museo-session-ready"));
}


/* ================= BOOT ================= */

const session = getSession();
if (validSession(session)) {
  startReact();
} else {

  fetch(`${API}/musei`)
    .then(r => r.json())
    .then(d => d.musei.forEach(n => {
      const o = document.createElement("option");
      o.value = o.textContent = n;
      museoSel.appendChild(o);
    }));

  museoSel.onchange = () => {
    percorsoSel.innerHTML = '<option value="">— seleziona percorso —</option>';
    percorsoSel.disabled = true;
    if (!museoSel.value) return;

    fetch(`${API}/musei/${encodeURIComponent(museoSel.value)}/percorsi`)
      .then(r => r.json())
      .then(d => {
        d.percorsi.forEach(p => {
          const o = document.createElement("option");
          o.value = o.textContent = p.nome;
          percorsoSel.appendChild(o);
        });
        percorsoSel.disabled = false;
      });
  };
btn.onclick = () => {
  if (!museoSel.value || !percorsoSel.value)
    return alert("Seleziona museo e percorso");

  fetch(`${API}/musei/${encodeURIComponent(museoSel.value)}/percorsi/${encodeURIComponent(percorsoSel.value)}`)
    .then(r => r.json())
    .then(d => {
      // Salva percorso nei cookie
      const percorsoArr = ["IN", ...d.oggetti, "OUT"];
      setSession({
        museo: museoSel.value,
        percorso: percorsoArr,
        createdAt: Date.now()
      });

      // Aggiorna URL: ?stanza=IN/path/IN/primoOggetto
      if (percorsoArr.length >= 2) {
        const stanza = percorsoArr[0];
        const primoOggetto = encodeURIComponent(percorsoArr[1]); // solo l'oggetto
        history.replaceState(
          null,
          "",
          `/?stanza=${stanza}/path/${stanza}/${primoOggetto}`
        );
      }

      startReact();
    })
    .catch(() => alert("Errore percorso"));
};

}
</script>

<!-- React -->
<script type="module" src="/src/main.tsx"></script>

</body>
</html>
